\documentclass{article}

% packages
\usepackage[a4paper, margin=2.2cm]{geometry}
\usepackage{multicol}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{minted}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{parskip}
\usepackage{amsmath}
\usepackage{xcolor}
\usepackage[justification=centering, margin=1.6cm]{caption}
\usepackage{graphics}

\pgfplotsset{compat=1.16}

\newlength\figurewidth
\newlength\figureheight
\setlength\figurewidth{0.4\textwidth}
\setlength\figureheight{0.4\textwidth}

\begin{document}

    \begin{titlepage}
        \begin{center}
            \vspace*{2cm}
            
            {\huge \textbf{xCore-200 Cellular Automaton Farm}}
            
            \vspace{0.5cm}
            
            {\Large COMS20001 Concurrent Computing CW1}
            
            \vspace{0.5cm}
            
            {\large Team 6}
            
            \vspace{1cm}
            
            \hspace*{1cm} {\Large \textbf{Ruairi Fox}} \hfill {\Large \textbf{Liam Dalgarno}} \hspace*{1cm} \\~\\[-0.5em]
            \hspace*{1cm} MEng. Computer Science \hfill MEng. Computer Science  \hspace*{1cm} \\~\\[-1em]
            \hspace*{1cm} rf17160@bristol.ac.uk  \hfill ld17285@bristol.ac.uk  \hspace*{1cm} 
            
            \vspace{1cm}
            
            {\large \today}
        \end{center}
    \end{titlepage}

    \section{Functionality and Design}
    \subsection{Design Overview}
    To implement Conway's game of life, one of the first design decision we had was to split the board's rows between the workers. If we had two workers and 16 rows then each worker would get 8 rows. This does not actually work though as each worker needs information from the rows directly above and below it's block. To do this, we have the workers each send their redundant rows to each other. In order to make sure that output arrives in the correct order we have the distributor send a flag to the workers who will then send their portion of the board only when they have the flag. They then return the flag afterwards so that another worker can send their data. We would have had a direct channel between the workers and the data\_out but we are restricted by the hard limits of channels imposed by the board. 
    \subsection{Bit packing}
    During the program we pack 32 uchars into a single Int value allowing us to transfer the data far more quickly across channels. As well as this, The reduced size means that it is actually possible to keep the larger images on the board and process them, as without packing we would run out of space.
    \subsection{Operating in place}
    Rather than unpacking our data we decided to operate on it in place. This helps us avoid the memory and CPU overhead of packing and unpacking the data each time. During computation each processed row overwrites the row above it's original position, as that row is no longer needed for processing. This means we do not need to allocate another array to hold the results of processing.

    \begin{figure}[h]
        \begin{center}
            \input{evolve.tex}
            \caption{Code that will allow the system to operate in place. }
            \label{fig:inplace}
        \end{center}
    \end{figure}
    
    
    \subsection{Concurrent Workers}
    Our program implements multiple concurrent threads working in parallel. The distributor sends the worker threads a portion of the board initially after which the workers communicate amongst themselves to transfer redundant rows.
    \subsection{Top and bottom}
    As the workers communicate between themselves for redundant rows there is potential for a deadlock if the order of sending is not well defined. Because of this, We pass a flag into each worker that defines if they send first (top) or receive first (bottom). This  allows us to concurrently send the ghost rows between threads.


    \newpage
    \section{Tests and Experiments}
    
    We tested our system in multiple ways, such as:
    
    \begin{itemize}
        \setlength\itemsep{-0.2\baselineskip}
        \item Comparing two iterations of a \verb|32x32| image to another implementation of the Game of Life. (Figure \ref{fig:test32})
        \item Examining some sample generations of a \verb|1024x1024| image starting from a straight line. (Figure \ref{fig:test1024})
        \item Varying the worker count and image size. (Section \ref{workercount})
        \item Changing the distribution of workers across the tiles. (Section \ref{workerdistribution})
        \item Comparing asynchronous channels with synchronous channels. (Section \ref{asyncchannels})
    \end{itemize}
    
    \begin{figure}[h]
        \begin{center}
            \includegraphics[width=0.15\textwidth]{test32.png}
            \includegraphics[width=0.15\textwidth]{testout32-1.png}
            \includegraphics[width=0.15\textwidth]{testout32-2.png}
            \includegraphics[width=0.15\textwidth]{verify32.png}
            \includegraphics[width=0.15\textwidth]{verify32-1.png}
            \includegraphics[width=0.15\textwidth]{verify32-2.png}
            \caption{State following 2 iterations of a \texttt{32x32} image. \\ Left: our system; Right: \texttt{https://bitstorm.org/gameoflife/}}
            \label{fig:test32}
        \end{center}
    \end{figure}

    \begin{figure}[h]
        \begin{center}
            \includegraphics[width=0.2\textwidth]{test1024.png}
            \includegraphics[width=0.2\textwidth]{testout1024-1.png}
            \includegraphics[width=0.2\textwidth]{testout1024-2.png}
            \includegraphics[width=0.2\textwidth]{testout1024-3.png}
            \caption{Example generations of a \texttt{1024x1024} image, beginning from a straight line.}
            \label{fig:test1024}
        \end{center}
    \end{figure}
    
    \subsection{Worker Count} 
    \label{workercount}

    \begin{figure}[h]
        \begin{center}
            \input{table.tex}
            \caption{The effect of increasing worker count and size of image on Average Generation Time.}
            \label{fig:agt}
        \end{center}
    \end{figure}
    
    \begin{figure}[h]
        \begin{center}
            \input{agtplot.tex}
            \caption{Log plot of Average Generation Time vs. Worker Count.}
            \label{fig:agtplot}
        \end{center}
    \end{figure}

    We can measure the processing speed by the AGT (Average Generation Time). From Figure \ref{fig:agt} it's clear that increasing the number of workers is effective at reducing the AGT, although only up to a point. Regardless of worker count, the AGT for \verb|64x64| and \verb|32x32| remains at 11.64, and the AGT for \verb|128x128| with 8 workers is also 11.64. This implies that there is a limitation on our system. (see Section \ref{limits})

    However for the larger images, doubling the worker count halves the AGT, which implies that increasing the workers gives a \textit{linear} speed up, and this is reflected by the straight lines in Figure \ref{fig:agtplot}. Furthermore, increasing the image size by a factor of 4 also increases the AGT by a factor of 4; this is expected since an $n$-fold increase in the number of cells is an $n$-fold increase in the amount of work. A nice consequence of this behaviour is that the AGT of an image with $n$ cells and $m$ workers is approximately the same as the AGT of an image with $4n$ cells and $4m$ workers (e.g. the AGT of \verb|128x128| with 2 workers is approximately equal to the AGT of \verb|256x256| with 8 workers).

    \subsection{Worker Distribution} 
    \label{workerdistribution}

    In the \verb|xCore-200| there are \textbf{hard} and \textbf{soft} channels, where hard channels are across physical tiles, and soft channels are between individual threads on a tile. Hard channels will have higher latency since the data must travel a larger distance in comparison to a soft channel. We can vary the number of hard channels by either changing the position of the distributor with respect to the tiles, or by varying the tile distribution of the workers. Alternating the tiles for the workers will result in more hard channels since adjacent workers will be on separate tiles. However, having the first $\frac{n}{2}$ workers on one tile and the remaining on the other will result in hard channels between only two workers.

    In our experiment we tested the distributor position using 4 workers (as we cannot have more than 8 threads on a single tile), and the worker distribution using both 8 and 4 workers.

    \begin{figure}[h]
        \begin{center}
            \input{distributordistribution.tex}
            \input{workerdistribution.tex}
            \caption{Varying the communication channels between the distributor and workers.}
            \label{fig:distribution}
        \end{center}
    \end{figure}

    \subsection{Asynchronous Channels} 
    \label{asyncchannels}

    

    \pagebreak

    % ?? is a placeholder for a future citation :)
    \section{Critical Analysis} 
    \label{analysis}

\end{document}